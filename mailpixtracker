#!/bin/bash
# Mail Pix(el) Tracker
# https://github.com/ColasNahaboo/mailpixtracker
# (c) 2025 Colas Nahaboo
# License: GPL v3
export VERSION=1.0.4

# parameters of the request
# url/mailpixtracker            # main menu
# url/mailpixtracker/new        # create a new tracker id
# url/mailpixtracker/id/NN      # provide code for id NN, and display access logs
# url/mailpixtracker/pix/NN     # log an access from email with tracker of id NN

# script is called by https://my.host.org/cgi-bin/mailpixtracker/command/id
ROOT_URL="$REQUEST_SCHEME://$HTTP_HOST"
name="${SCRIPT_NAME##*/}"       # the name of the script, can be anything
url="$ROOT_URL$SCRIPT_NAME"     # its URL
params="$PATH_INFO"             # arguments of the request

# you can redefine the location of the config file via this env variable
if [[ -n "$MAILPIXELTRACKER_CONF" ]]; then config="$MAILPIXELTRACKER_CONF"
else config="$name.conf"
fi
#############################################################################
# config vars, can be redefined in config file mailpixtracker.conf
export TZ=                      # timezone used for dates in logs
export dir=.                    # where to store logs and cached data
export dateformat='%Y-%m-%d.%Hh%M,%S' # format of dates in logs.
                                # true ISO:  YYYY-MM-DDTHH:MN:SS
                                # default more readble: YYYY-MM-DD.HHhMN,SS
export style=                   # optional HTML code included in header, e.g:
                                # style='<style>h1 {font-family:arial;}</style>'
                                # style='<link rel="stylesheet" href="..." />'
# optional header code at start of html body
export header=
# optional footer code at end of html body
export footer="<hr><a href='https://github.com/ColasNahaboo/mailpixtracker'>mailpixeltracker</a> v$VERSION"
#############################################################################

# load config file if present as a bash script to redefine the above vars
# shellcheck disable=SC1090 # Ok to not check included file syntax
[[ -e "$config" ]] && . "$config"

################################# No params: menu
if [[ -z "$params" ]]; then
    title="Mail Pixel Tracker"
    echo "Content-Type:text/html"; echo
    echo "<!doctype html><head>$style<title>$title</title></head><body>$header"
    echo "<h1>$title</h1>
<ul><li><a href='$url/new'>Create a new tracker to insert in emails</a>"
    if [[ -d "$dir/$name-log" ]]; then
        echo "<li>Show logs for existing trackers:<ul>"
        # shellcheck disable=SC2012   # Allow ls instead of find
        while read -r id; do
            if [[ -s "$dir/$name-log/$id" ]]; then
                last=$(tail -1 "$dir/$name-log/$id" | cut -f 1 -d ' ')
                echo "<li><a href='$url/id/$id'>$id</a>, last log on $last</li>"
            fi
        done < <(ls -1 "$dir/$name-log" |sort -nr)
        echo "</ul>"
    fi
    echo "</ul>$footer</body>"
    exit 0
fi

################################# new ID, allocate & redirect to log page

if [[ "$params" = /new ]]; then
    id=0
    [[ -s "$dir/$name-n" ]] && id=$(cat "$dir/$name-n")
    ((id++))
    mkdir -p "$dir"
    echo "$id" >"$dir/$name-n"
    echo "Location:$url/id/$id"; echo
    exit 0
fi

################################# show the log for an ID

if [[ $params =~ /id/([[:digit:]]+)$ ]]; then
    id="${BASH_REMATCH[1]}"
    title="Mail Pixel Tracker for ID # $id"
    mkdir -p "$dir"
    echo "Content-Type:text/html"; echo
    echo "<!doctype html><head>$style<title>$title</title></head><body>$header"
    echo "$id" >"$dir/$name-n"
    echo "<h1>$title</h1>
<p>To insert a tracker od ID # $id in an email, 
insert the below code in gmail via <a href='https://addons.mozilla.org/en-US/firefox/addon/htmail/'>HTMail</a><br />(icon: <img height='22px' src='data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACQAAAAkCAMAAADW3miqAAAAAXNSR0IB2cksfwAAAAlwSFlzAAAWJQAAFiUBSVIk8AAAAf5QTFRFAAAAREdGREdGREdGREdGREdGRklIRUhHREdGRklIU1ZVS05NWVxbS05NRklIVFdWXmFgRklISUxLc3V0XV9eW11dTlFQRUhHTlFQXV9fWFtaUFNSR0pJSUxLS05NRklIV1lZS05NRklITE9OoqOiZ2loTE9ORklIRUhHTE9OV1pZRklITE5OTVBPR0pJSUxLWFpaSEtKSEtKVVhXTU9ORUhHUVRTZWdmTE9OREdGRklIT1JRUFJRRklIRUhHTE9OXmFgdHd2SEtKR0pJd3p5U1VUS05Nd3p5SEtKTE9Ob3FwRUhHTlFQUVRTRklIRklIW15dU1VVSEtKSEtKT1JRSk1MRklIVVhXV1pZSk1MRklITE9OXmFgSUxLRUhHRklIS05Nam1sWFtaR0pJSEtKUFJRSEtKRUhHSEtKUlVUTlFQR0pJTVBPRUhHTU9OTU9PRUhHRkhHS05NaGtqWFtaS05NSUxLSEtKR0lIZmdnTE9OR0pJVFdW0NHRiIqJcHNySk1M6OjoYmVkUFNSRklITE9OUlVUWVxbSUxLR0pJR0pJSEtKhIaFUlVUSUxLRklITE5OTU9OTlBPSEtKRUhHY2VkTE9OSEtKSk1MVVhXVFZVSk1MTE5NUlVUSUxLTVBPZGZlTU9OR0pJYWRjeXp5UFNSSUxLRUhHSEtKTE9O72fMGwAAAKp0Uk5TAGzl/v9r5paSlhSfE33nGgfVlQEHFzP6QwkVKLjFjuAMbd1YAANh7vJiEex7KNWcFLnBG1T4JASB+99BO+r0cQUCp8gCNogBsncB82NE8+sRHrSpJnnoEAp91k0GfO7hVwINy6UwvfyhHT/KRPlSQ/DtaAMKka6a0ghbux8AAQeAAAQ3y2UqD2jHs7EBJIDaVDY9n5QIWcieGRmDejCsYAdgyQYBLIj9r1dZoUPtAAABw0lEQVR4nL2UQUgUYRTH32/XpRBCQQkkEIICMdQ9CF086GGhSwcPQpBdAoliay8LoRC7K4WwKCxBKBEplAfTQ4cIFA9dNFqIDsVGkBQkEkliURTszk7fN7O4MzvjzK13ee//fb/vfY/3zTwEZXK4mWa0TMwMIGwziEQigZkwqlWixP4E5jlimDRJ099A6GhFfKBm+BUKHYMfYVCrasn3Q6F2drU7Dl+lgx1f6AR80b4TPstJle6jBzqtG/9eBd3wTqSH0plyqQGK87aX13qtH4rKndWHNlzQgF56oZeGVLBuZUhs/e5j1QGdW0/w3K4szrNaxecV/9QBDbMxwIreGYElC7nAzxYWXTWN6vuYl8vwwGLGtJ5tbME1Kp/WJAl3tUppZsbbpzTk5SZMaTEBt307fovJzMpI1ha5jO0nIdvwdnc+dE0433EKtlVhbigP6QNx6qpS1kfrhgqkDpAbPHlZixVUSIrH7sH1ulJQW44rbuQ+01tOrSCVOp3er5cyzuwb9yELErk4OPfKChYoznn+sBok8nCv7dJjWF30FliH5BF8W970QZxQgP1vKBo0Umwz1egJhaoQDb8NiRkh49A0/wFMNn+lFDGoAQAAAABJRU5ErkJggg=='> at the bottom right of the mail compose window)
<p>
<large style='background-color:#ffffdd'><code class=mptcode>&lt;img src='$url/pix/$id' width='1' height='1'&gt;</code></large>
<p>
(or go back to the <a href='$url'>main MailPixelTracker menu</a>)<p>"
    if [[ -s "$dir/$name-log/$id" ]]; then
	echo "<h2>Access logs for ID # $id</h2><br><table class=mptlog>"
        # To maximize perceptual spacing, I used golden-angle hue sampling
        # (137.508Â° steps), a well-known approximation of greedy max-min spacing
        # to allow distinct colors to distinct IPs
        colors[0]='#f7f7f7'
        colors[1]='hsl( 92.5, 60%, 95%)'
        colors[2]='hsl(315.0, 60%, 95%)'
        colors[3]='hsl(177.5, 60%, 95%)'
        colors[4]='hsl( 40.0, 60%, 95%)'
        colors[5]='hsl(262.5, 60%, 95%)'
        colors[6]='hsl(125.0, 60%, 95%)'
        colors[7]='hsl(347.5, 60%, 95%)'
        colors[8]='hsl(210.0, 60%, 95%)'
        colors[9]='hsl( 72.5, 60%, 95%)'
        colors[10]='hsl(295.0, 60%, 95%)'
        colors[11]='hsl(157.5, 60%, 95%)'
        colors[12]='hsl( 20.0, 60%, 95%)'
        colors[13]='hsl(242.5, 60%, 95%)'
        colors[14]='hsl(105.0, 60%, 95%)'
        colors[15]='hsl(327.5, 60%, 95%)'
        colors[16]='hsl(190.0, 60%, 95%)'
        colors[17]='hsl( 52.5, 60%, 95%)'
        colors[18]='hsl(275.0, 60%, 95%)'
        colors[19]='hsl(137.5, 60%, 95%)'
        colors[20]='hsl(  0, 60%, 95%)'
        color_unknown='#eee'
        # we parse the list of all mentioned ips, to use as indexes in colors[]
        ipx=0
        declare -A ips
        while read -r line; do
            if [[ $line =~ \[([.[:digit:]]+)\] ]]; then
                ip=_"${BASH_REMATCH[1]//./_}"
                if [[ -z "${ips[$ip]}" ]]; then
                    echo "<*#[ips[$ip] = $ipx]#*>" >&2
                    # shellcheck disable=SC2004 # ip is not a numeric index
                    ips[$ip]="$ipx"
                    ((ipx++))
                fi
            fi
        done <"$dir/$name-log/$id"
        
	while read -r line; do
            if [[ $line =~ ^(.+)\ (\[([.[:digit:]]+)\]\ [(][^\)]*[)])( - .*) ]]; then
                ip=_"${BASH_REMATCH[3]//./_}"
                ipx="${ips[$ip]}"
                color="${colors[$ipx]}"
                echo "<tr><td style='background-color:$color'><b>${BASH_REMATCH[1]}</b> ${BASH_REMATCH[2]}<small style='color:#888'>${BASH_REMATCH[4]}</small>"                                                  
            else
                echo "<tr><td style='background-color:$color_unknown'><b>${line%% *}</b> ${line#* }"
            fi
        done < <(tac "$dir/$name-log/$id")
        echo "</table>"
    else
	echo "No access logs yet for ID # $id"; echo
    fi
    echo "$footer</body>"
    exit 0
fi

mkdir -p "$dir/$name-log"

################################# provide a 1x1 pixel, and log the ID access

if [[ $params =~ /pix/([[:digit:]]+)$ ]]; then
    id="${BASH_REMATCH[1]}"
    date=$(date +"$dateformat")
    clienthost=$(host "$REMOTE_ADDR")
    clientname=
    [[ $clienthost =~ 'domain name pointer '(.+)[.]$ ]] && clientname="${BASH_REMATCH[1]}"
    echo "$date [$REMOTE_ADDR] ($clientname) - $HTTP_USER_AGENT" >>"$dir/$name-log/$id"
    echo 'Content-Type:image/png'; echo
    [[ -e "$dir/$name-1px.png" ]] || # cache 1x1 transparent pixel PNG if needed
        mkdir -p "$dir"
	base64 -d <<<'iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChwGA60e6kgAAAABJRU5ErkJggg==' >"$dir/$name-1px.png"
    cat "$dir/$name-1px.png"
    exit 0
fi

################################# unknown use ==> main menu

echo "Location:$url"; echo
exit 0
