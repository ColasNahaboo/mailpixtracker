#!/bin/bash
# Mail Pix(el) Tracker
# https://github.com/ColasNahaboo/mailpixtracker
# (c) 2025 Colas Nahaboo
# License: GPL v3
export VERSION=2.2.2

# parameters of the request
# url/mailpixtracker            # main menu
# url/mailpixtracker/new        # create a new tracker id
# url/mailpixtracker/id/NN      # provide code for id NN, and display access logs
# url/mailpixtracker/pix/NN     # log an access from email with tracker of id NN

# script is called by https://my.host.org/cgi-bin/mailpixtracker/command/id
ROOT_URL="$REQUEST_SCHEME://$HTTP_HOST"
name="${SCRIPT_NAME##*/}"       # the name of the script, can be anything
url="$ROOT_URL$SCRIPT_NAME"     # its URL
params="$PATH_INFO"             # arguments of the request
nl=$'\n';  tab=$'\t'            # some useful constants
# shellcheck disable=SC2034     # don't warn when L is unused
L=/tmp/mailpixtracker.log       # debuging by echo "..." >>$L

# you can redefine the location of the optional config files via env variables
# global for all names
if [[ -n "$MAILPIXTRACKER_GLOBALCONF" ]]; then gconfig="$MAILPIXTRACKER_GLOBALCONF"
else gconfig="mpt.conf"
fi
# only for this script name
if [[ -n "$MAILPIXTRACKER_CONF" ]]; then config="$MAILPIXTRACKER_CONF"
else config="$name.conf"
fi
#############################################################################
# config vars, can be redefined in config file mailpixtracker.conf
export TZ=                      # timezone used for dates in logs
export dir=.                    # where to store logs and cached data
export dateformat='%Y-%m-%d.%Hh%M,%S' # format of dates in logs.
                                # true ISO:  YYYY-MM-DDTHH:MN:SS
                                # default more readble: YYYY-MM-DD.HHhMN,SS
# optional HTML code included in header
export style=""
# optional header code at start of html body
export header=
# optional footer code at end of html body
export footer="<hr><a href='https://github.com/ColasNahaboo/mailpixtracker'>mailpixtracker</a> v$VERSION"
# built-in styling is regrouped here, keeping it is recommended.
export mptstyle="table.mptlog td {padding: 0.1rem 0.4rem}
table.mptlog td.useragent {font-size:small; color:#888888}
table.mptlog td.new {background-color:yellow}
code.mptcode {font-size: large; background-color:#ffffdd}
input,textarea {padding: 0.2rem 0.2rem}
h1 {font-size:1.6rem}
h2 {font-size:1.3rem}
"
#############################################################################

# load config files if present as a bash script to redefine the above vars
# shellcheck disable=SC1090 # Ok to not check included file syntax
[[ -e "$gconfig" ]] && . "$gconfig"
# shellcheck disable=SC1090
[[ -e "$config" ]] && . "$config"

################################# TRACK: provide a 1x1 pixel, log the ID access
# first, handle the tracker notifications as fast as possible

if [[ $params =~ /pix/([[:digit:]]+)$ ]]; then
    mkdir -p "$dir/$name-log"
    id="${BASH_REMATCH[1]}"
    date=$(date +"$dateformat")
    clienthost=$(host "$REMOTE_ADDR")
    clientname=
    [[ $clienthost =~ 'domain name pointer '(.+)[.]$ ]] && clientname="${BASH_REMATCH[1]}"
    # old v1 format was:
    # echo "$date [$REMOTE_ADDR] ($clientname) - $HTTP_USER_AGENT" >>"$dir/$name-log/$id"
    echo "$date${tab}$REMOTE_ADDR${tab}$clientname${tab}$HTTP_USER_AGENT" >>"$dir/$name-log/$id"
    echo "Content-Type:image/png$nl"
    [[ -e "$dir/$name-1px.png" ]] || # cache 1x1 transparent pixel PNG if needed
        mkdir -p "$dir"
	base64 -d <<<'iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChwGA60e6kgAAAABJRU5ErkJggg==' >"$dir/$name-1px.png"
    cat "$dir/$name-1px.png"
    exit 0
fi

################################# REST
# We can now take our time, parse the args...
# shellcheck disable=SC1091 # Ok to not check included file syntax
. cgibashopts

# quotes text for inclusion, and replace nl by tab for textarea contents
html_escape() {
    local s="$1"
    s=${s//&/\&amp;}; s=${s//</\&lt;}; s=${s//>/\&gt;}
    s=${s//\"/\&quot;}; s=${s//\'/\&#39;}; s="${s//$nl/$tab}"
    printf '%s' "$s"
}

################################# MAIN menu
if [[ -z "$params" ]]; then
    title="Mail Pixel Tracker"
    echo "Content-Type:text/html$nl"
    echo "<!doctype html><head>$style<style>$mptstyle</style><title>$title</title></head><body>$header"
    echo "<h1>$title</h1>
          <form action='$url/new' method=POST>
          <ul><li>Create a new tracker to insert in emails named:
          <input type=text name=name size=48 value=''>
          <input type=submit value='Create'>"
    if [[ -d "$dir/$name-log" ]]; then
        echo "<li>Show logs for existing trackers:<ul>"
        # shellcheck disable=SC2010,SC2012   # Allow ls instead of find
        while read -r id; do
            if [[ -s "$dir/$name-log/$id" ]]; then
                last=$(tail -1 "$dir/$name-log/$id" | cut -f 1 -d ' ')
                idname=$(grep -soPm1 '^name +\K.*' "$dir/$name-log/$id.meta")
                [[ -n "$idname" ]] && idname=" <b>$idname</b>"
                echo "<li><a href='$url/id/$id'>$id</a>$idname, last log on $last</li>"
            fi
        done < <(ls -1 "$dir/$name-log" | grep -Ex '[[:digit:]]+' | sort -nr)
        echo "</ul></form>"
    fi
    echo "</ul>$footer</body>"
    exit 0
fi

################################# NEW ID creation, then redirect to log page

if [[ "$params" = /new ]]; then
    # find next available id
    # shellcheck disable=SC2010,SC2012   # Allow ls instead of find
    id=$(ls -1 "$dir/$name-log" | grep -Ex '[[:digit:]]+' | sort -nr | head -1)
    ((id++))
    mkdir -p "$dir"
    true >"$dir/$name-log/$id"
    true >"$dir/$name-log/$id.meta"
    if [[ -n "$FORM_name" ]]; then
        qname=$(html_escape "$FORM_name")
        echo "name $qname" >>"$dir/$name-log/$id.meta"
    fi
    echo "Location:$url/id/$id$nl"
    exit 0
fi

################################# META modification, then redirect to log page

if [[ "$params" = /meta ]]; then
    # shellcheck disable=SC2154 # $FORM_id is defined elsewhere
    id="$FORM_id"
    rest=$(grep -vsE  '^(name|note) ' "$dir/$name-log/$id.meta")
    rm -f "$dir/$name-log/$id.meta"
    if [[ -n "$FORM_name" ]]; then
        qname=$(html_escape "$FORM_name")
        echo "name $qname" >>"$dir/$name-log/$id.meta"
    fi
    if [[ -n "$FORM_note" ]]; then
        qnote=$(html_escape "$FORM_note")
        echo "note $qnote" >>"$dir/$name-log/$id.meta"
    fi
    [[ -n "$rest" ]] && echo "$rest" >>"$dir/$name-log/$id.meta"
    echo "Location:$url/id/$id$nl"
    exit 0
fi

################################# LOG: shows the log for an ID

if [[ $params =~ /id/([[:digit:]]+)$ ]]; then
    id="${BASH_REMATCH[1]}"
    idname=$(grep -soPm1 '^name +\K.*' "$dir/$name-log/$id.meta")
    idnamef=; [[ -n "$idname" ]] && idnamef=", $idname"
    idnoteq=$(grep -soPm1 '^note +\K.*' "$dir/$name-log/$id.meta")
    idnote="${idnoteq//$tab/$nl}"
    idnotenls="${idnoteq//[^$tab]/}"
    idnotel=$((${#idnotenls} + 2)) # number of notes lines
    title="Mail Pixel Tracker #$id$idnamef"
    mkdir -p "$dir"
    echo "Content-Type:text/html

<!doctype html><head>$style<style>$mptstyle</style><title>$title</title></head><body>$header
       <a href='$url'>[Main Menu]</a><br>
       <h1>$title</h1>
       <p>To insert a tracker of ID # $id in an email, insert the below code in gmail via <a href='https://addons.mozilla.org/en-US/firefox/addon/htmail/'>HTMail</a><br />(icon:
       <img src='data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABYAAAAWCAMAAADzapwJAAAAAXNSR0IB2cksfwAAAARnQU1BAACxjwv8YQUAAAAgY0hSTQAAeiYAAICEAAD6AAAAgOgAAHUwAADqYAAAOpgAABdwnLpRPAAAAgFQTFRFAAAAAAAAREdGREdGREdGREdGREdGRklIRUhHREdGRklIU1ZVS05NWVxbS05NRklIVFdWXmFgRklISUxLc3V0XV9eW11dTlFQRUhHTlFQXV9fWFtaUFNSR0pJSUxLS05NRklIV1lZS05NRklITE9OoqOiZ2loTE9ORklIRUhHTE9OV1pZRklITE5OTVBPR0pJSUxLWFpaSEtKSEtKVVhXTU9ORUhHUVRTZWdmTE9OREdGRklIT1JRUFJRRklIRUhHTE9OXmFgdHd2SEtKR0pJd3p5U1VUS05Nd3p5SEtKTE9Ob3FwRUhHTlFQUVRTRklIRklIW15dU1VVSEtKSEtKT1JRSk1MRklIVVhXV1pZSk1MRklITE9OXmFgSUxLRUhHRklIS05Nam1sWFtaR0pJSEtKUFJRSEtKRUhHSEtKUlVUTlFQR0pJTVBPRUhHTU9OTU9PRUhHRkhHS05NaGtqWFtaS05NSUxLSEtKR0lIZmdnTE9OR0pJVFdW0NHRiIqJcHNySk1M6OjoYmVkUFNSRklITE9OUlVUWVxbSUxLR0pJR0pJSEtKhIaFUlVUSUxLRklITE5OTU9OTlBPSEtKRUhHY2VkTE9OSEtKSk1MVVhXVFZVSk1MTE5NUlVUSUxLTVBPZGZlTU9OR0pJYWRjeXp5UFNSSUxLRUhHSEtKTE9OQSeK0AAAAAF0Uk5TAEDm2GYAAAABYktHRACIBR1IAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAB3RJTUUH6QsZBDAYbH3PlwAAAGpJREFUGNOtkTESgEAIAzNpQm/NJ+53/l4d9eDktJJyJwlMADgZgCrQRNBQZpcfjm/sc6wndl1iecJKGeq4eVrnHiEaxLFyAdYIernbArebNWNVy86uhk56bUevltwJk+ruAdc//ILnL94Az6AE8m6Sfn0AAAAASUVORK5CYII='> at the bottom right of the mail compose window)
        <p>
        <code class=mptcode>&lt;img src='$url/pix/$id' width='1' height='1'&gt;</code>
        <p>
        <h2>Info for #$id</h2>
        <form action='$url/meta' method=POST>
        <input type=hidden name=id value='$id'>
        <table class=mptlog><tr><th>Name:<td><input type=text name=name size=64 value='$idname'>
        <tr><th>Notes:<td><textarea name=note rows=$idnotel cols=71>$idnote</textarea>
        <tr style='text-align:left'><td><td><input type=submit value='Modify'>
        </table></form>
        <h2>Access logs</h2>"
    if [[ -s "$dir/$name-log/$id" ]]; then
        echo "<table class=mptlog>
        <tr><th>#<th>Date+Time<th>IP address<th>Hostname<th>User Agent"
        # To maximize perceptual spacing, I used golden-angle hue sampling
        # (137.508Â° steps), a well-known approximation of greedy max-min spacing
        # to allow distinct colors to distinct IPs
        colors[0]='#f7f7f7'
        colors[1]='hsl( 92.5, 60%, 95%)'
        colors[2]='hsl(315.0, 60%, 95%)'
        colors[3]='hsl(177.5, 60%, 95%)'
        colors[4]='hsl( 40.0, 60%, 95%)'
        colors[5]='hsl(262.5, 60%, 95%)'
        colors[6]='hsl(125.0, 60%, 95%)'
        colors[7]='hsl(347.5, 60%, 95%)'
        colors[8]='hsl(210.0, 60%, 95%)'
        colors[9]='hsl( 72.5, 60%, 95%)'
        colors[10]='hsl(295.0, 60%, 95%)'
        colors[11]='hsl(157.5, 60%, 95%)'
        colors[12]='hsl( 20.0, 60%, 95%)'
        colors[13]='hsl(242.5, 60%, 95%)'
        colors[14]='hsl(105.0, 60%, 95%)'
        colors[15]='hsl(327.5, 60%, 95%)'
        colors[16]='hsl(190.0, 60%, 95%)'
        colors[17]='hsl( 52.5, 60%, 95%)'
        colors[18]='hsl(275.0, 60%, 95%)'
        colors[19]='hsl(137.5, 60%, 95%)'
        colors[20]='hsl(  0, 60%, 95%)'
        color_unknown='#eee'
        # we parse the list of all mentioned ips, to use as indexes in colors[]
        ipx=0
        declare -A ips
        while read -r line; do
            if [[ $line =~ ^[^$tab]+$tab([^$tab]+) ]]; then # v2 format
                ipk=_"${BASH_REMATCH[1]//./_}"
            elif [[ $line =~ \[([.[:digit:]]+)\] ]]; then # v1 format
                ipk=_"${BASH_REMATCH[1]//./_}"
            else
                continue
            fi
            if [[ -z "${ips[$ipk]}" ]]; then
                # shellcheck disable=SC2004 # ip is not a numeric index
                ips[$ipk]="$ipx"
                ((ipx++))
            fi
        done <"$dir/$name-log/$id"
        lastseen=$(date -r "$dir/$name-log/$id.meta" +"$dateformat" 2>/dev/null)
	while read -r line; do
            date=
            # v2 format line
            if [[ $line =~ ^([^$tab]+)$tab([^$tab]+)$tab([^$tab]*)$tab(.*) ]]; then
                date="${BASH_REMATCH[1]}"
                ip="${BASH_REMATCH[2]}"
                host="${BASH_REMATCH[3]}"
                agent="${BASH_REMATCH[4]}"
            # v1 format line
            elif [[ $line =~ ^(.+)\ \[([.[:digit:]]+)\]\ [(]([^\)]*)[)]\ -\ (.*) ]]; then
                date="${BASH_REMATCH[1]}"
                ip="${BASH_REMATCH[2]}"
                host="${BASH_REMATCH[3]}"
                agent="${BASH_REMATCH[4]}"
            fi
            if [[ -n "$date" ]]; then
                ipk="_${ip//./_}"
                ipx="${ips[$ipk]}"
                color="${colors[$ipx]}"
                isnew=old; [[ "$date" > "$lastseen" ]] && isnew=new
                echo "<tr style='background-color:$color'><td class='$isnew idx'>$ipx<td><b>$date</b><td>$ip<td><i>$host</i><td class=useragent>$agent</small></tr>"
            else                # unknown format
                echo "<tr style='background-color:$color_unknown'><td><td colspan=4>${line}"
            fi
        done < <(tac "$dir/$name-log/$id")
        echo "</table>"
    else
	echo "No access logs yet"
    fi
    echo "$footer</body>"
    touch "$dir/$name-log/$id.meta"
    exit 0
fi

################################# DEFAULT: unknown param ==> main menu

echo "Location:$url$nl"
exit 0
